<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📈 Revenue Compare</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .company-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 10px 0;
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
            min-width: 200px;
        }
        .market-cap-display {
            font-size: 1rem;
            font-weight: 500;
            margin: 5px 0 15px 0;
            padding: 8px 15px;
            border-radius: 8px;
            display: inline-block;
            color: #333;
            background: #f0f0f0;
        }
        #companyName1 {
            color: #e74c3c;
            background: linear-gradient(45deg, #fff5f5, #ffe5e5);
            border-left: 4px solid #e74c3c;
        }
        #companyName2 {
            color: #3498db;
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            border-left: 4px solid #3498db;
        }
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        .input-group {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .fetch-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }
        .fetch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .exchange-rate-note {
            font-size: 12px;
            color: #868e96;
            text-align: center;
            margin-top: 15px;
        }
        .fetch-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #dee2e6;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
        }
        .autocomplete-suggestions div {
            padding: 12px 15px;
            cursor: pointer;
        }
        .autocomplete-suggestions div:hover {
            background-color: #f1f1f1;
        }
        .autocomplete-suggestions .active {
            background-color: #667eea;
            color: white;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #667eea;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .charts-container {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
            font-weight: 600;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
        .data-table-container {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
            overflow-x: auto;
        }
        .data-table-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .data-table th,
        .data-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        .data-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .data-table tr:hover {
            background-color: #f8f9fa;
        }
        .positive {
            color: #28a745;
            font-weight: 600;
        }
        .negative {
            color: #dc3545;
            font-weight: 600;
        }
        .error-message {
            background: linear-gradient(45deg, #ffe5e5, #fff0f0);
            color: #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
            border-left: 4px solid #dc3545;
        }
        .warning-message {
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #ffc107;
        }
        .success-message {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
            border-left: 4px solid #28a745;
        }
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
            .form-group {
                min-width: 100%;
            }
            .company-name {
                display: block;
                margin: 10px auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📈 Revenue Compare</h1>
            <div id="companyNames" style="margin-top: 10px;">
                <div id="companyName1" class="company-name" style="display: none;"></div>
                <div id="marketCap1" class="market-cap-display" style="display: none;"></div>
                <div id="companyName2" class="company-name" style="display: none;"></div>
                <div id="marketCap2" class="market-cap-display" style="display: none;"></div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <div class="form-group">
                    <label for="companySearch1">Company 1 (主公司)</label>
                    <input type="text" id="companySearch1" placeholder="Search by code or name..." autocomplete="off">
                    <input type="hidden" id="companyCode1">
                    <div class="autocomplete-suggestions" id="suggestions1"></div>
                </div>
                <div class="form-group">
                    <label for="companySearch2">Company 2 (比較公司)</label>
                    <input type="text" id="companySearch2" placeholder="Search or leave blank..." autocomplete="off">
                    <input type="hidden" id="companyCode2">
                    <div class="autocomplete-suggestions" id="suggestions2"></div>
                </div>
                <div class="form-group">
                    <label for="startDate">Start Date (起始日期)</label>
                    <input type="month" id="startDate" value="2024-01">
                </div>
                <div class="form-group">
                    <button id="fetchBtn" class="fetch-btn">📊 Fetch & Compare</button>
                </div>
            </div>
            <div class="exchange-rate-note">
                Note: Market Cap USD equivalent is calculated using a fixed rate of 30 TWD = 1 USD.
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Fetching financial data... This may take a moment.
        </div>

        <div id="errorContainer"></div>

        <div class="toggle-group" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;" id="globalToggleControls">
            <span>Show Companies:</span>
            <label class="switch">
                <input type="checkbox" id="toggleCompany1" checked>
                <span class="slider"></span>
            </label>
            <span id="toggleCompany1Label">Company 1</span>
            <label class="switch" style="margin-left: 20px;">
                <input type="checkbox" id="toggleCompany2" checked>
                <span class="slider"></span>
            </label>
            <span id="toggleCompany2Label">Company 2</span>
        </div>

        <div id="chartsContainer" class="charts-container">
            <!-- Chart canvases remain the same -->
            <div class="chart-card"><h3>📈 Monthly Revenue Trend</h3><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
            <div class="chart-card"><h3>📈 Monthly YoY Change</h3><div class="chart-container"><canvas id="monthlyYoYChart"></canvas></div></div>
            <div class="chart-card"><h3>📊 Quarterly Revenue Trend</h3><div class="chart-container"><canvas id="quarterlyChart"></canvas></div></div>
            <div class="chart-card"><h3>📊 Quarterly YoY Change</h3><div class="chart-container"><canvas id="quarterlyYoYChart"></canvas></div></div>
            <div class="chart-card"><h3>📅 Yearly Revenue Trend</h3><div class="chart-container"><canvas id="yearlyChart"></canvas></div></div>
            <div class="chart-card"><h3>📅 Yearly YoY Change</h3><div class="chart-container"><canvas id="yearlyYoYChart"></canvas></div></div>
        </div>

        <div id="dataTableContainer" class="data-table-container">
            <h3>📋 Monthly Revenue Data</h3>
            <table id="dataTable" class="data-table">
                <!-- Table structure remains the same -->
                <thead>
                    <tr>
                        <th>Date</th>
                        <th colspan="3">Company 1</th>
                        <th colspan="3">Company 2</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th>Revenue (M)</th>
                        <th>YoY %</th>
                        <th>YTD (M)</th>
                        <th>Revenue (M)</th>
                        <th>YoY %</th>
                        <th>YTD (M)</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let monthlyChart, monthlyYoYChart, quarterlyChart, quarterlyYoYChart, yearlyChart, yearlyYoYChart;
        let allData1 = [], allData2 = [];

        const API_CONFIG = {
            SEARCH_URL: '/api/search-company',
            REVENUE_URL: '/api/revenue',
            MARKET_CAP_URL: '/api/market-cap',
        };

        // --- Autocomplete Feature ---
        function setupAutocomplete(inputId, suggestionsId, codeId) {
            const searchInput = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(suggestionsId);
            const codeInput = document.getElementById(codeId);

            searchInput.addEventListener('input', async () => {
                const query = searchInput.value;
                if (query.length < 1) {
                    suggestionsContainer.innerHTML = '';
                    suggestionsContainer.style.display = 'none';
                    codeInput.value = '';
                    return;
                }

                try {
                    const response = await fetch(`${API_CONFIG.SEARCH_URL}?q=${encodeURIComponent(query)}`);
                    const companies = await response.json();
                    
                    suggestionsContainer.innerHTML = '';
                    if (companies.length > 0) {
                        companies.forEach(company => {
                            const div = document.createElement('div');
                            div.textContent = `${company.code} - ${company.name}`;
                            div.dataset.code = company.code;
                            div.dataset.name = company.name;
                            div.addEventListener('click', () => {
                                searchInput.value = `${company.code} - ${company.name}`;
                                codeInput.value = company.code;
                                suggestionsContainer.innerHTML = '';
                                suggestionsContainer.style.display = 'none';
                            });
                            suggestionsContainer.appendChild(div);
                        });
                        suggestionsContainer.style.display = 'block';
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Autocomplete fetch error:', error);
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target !== searchInput) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        setupAutocomplete('companySearch1', 'suggestions1', 'companyCode1');
        setupAutocomplete('companySearch2', 'suggestions2', 'companyCode2');

        // --- Data Fetching (New) ---
        async function fetchRevenueData(companyCode, startDate) {
            if (!companyCode) return null;
            try {
                const response = await fetch(API_CONFIG.REVENUE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ companyCode, startDate })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || `Server error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching revenue for ${companyCode}:`, error);
                showError(`Failed to fetch data for ${companyCode}: ${error.message}`);
                return null;
            }
        }

        async function fetchMarketCap(companyCode) {
            if (!companyCode) return null;
            try {
                const response = await fetch(API_CONFIG.MARKET_CAP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ companyCode })
                });
                if (!response.ok) {
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching market cap for ${companyCode}:`, error);
                return null;
            }
        }

        // --- Data Processing (Adapted) ---
        function processComparisonData(results1, results2) {
            const allMonths = new Set([
                ...results1.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`),
                ...results2.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`)
            ]);
            const sortedMonths = Array.from(allMonths).sort();

            const monthlyData = sortedMonths.map(dateStr => {
                const [year, month] = dateStr.split('-').map(Number);
                const r1 = results1.find(r => r && r.year === year && r.month === month);
                const r2 = results2.find(r => r && r.year === year && r.month === month);
                return {
                    date: dateStr,
                    revenue1: r1?.revenue ?? null,
                    revenue2: r2?.revenue ?? null,
                    yoy1: r1?.yoy_percent ?? null,
                    yoy2: r2?.yoy_percent ?? null
                };
            });

            const quarterlyData = {};
            monthlyData.forEach(d => {
                const q = Math.ceil(parseInt(d.date.split('-')[1]) / 3);
                const year = d.date.split('-')[0];
                const key = `${year}Q${q}`;
                if (!quarterlyData[key]) quarterlyData[key] = { revenue1: 0, revenue2: 0, count1: 0, count2: 0 };
                if (d.revenue1 !== null) {
                    quarterlyData[key].revenue1 += d.revenue1;
                    quarterlyData[key].count1++;
                }
                if (d.revenue2 !== null) {
                    quarterlyData[key].revenue2 += d.revenue2;
                    quarterlyData[key].count2++;
                }
            });

            Object.keys(quarterlyData).forEach(key => {
                const [year, q] = key.split('Q');
                const lastYearKey = `${parseInt(year) - 1}Q${q}`;
                if (quarterlyData[lastYearKey]) {
                    const lastYearQ = quarterlyData[lastYearKey];
                    const currentQ = quarterlyData[key];
                    if (lastYearQ.revenue1 > 0 && lastYearQ.count1 === 3 && currentQ.count1 === 3) {
                        currentQ.yoy1 = ((currentQ.revenue1 - lastYearQ.revenue1) / lastYearQ.revenue1) * 100;
                    }
                    if (lastYearQ.revenue2 > 0 && lastYearQ.count2 === 3 && currentQ.count2 === 3) {
                        currentQ.yoy2 = ((currentQ.revenue2 - lastYearQ.revenue2) / lastYearQ.revenue2) * 100;
                    }
                }
            });

            const quarterlyArray = Object.entries(quarterlyData).map(([key, q]) => ({
                date: key,
                revenue1: q.revenue1,
                revenue2: q.revenue2,
                yoy1: q.yoy1 ?? null,
                yoy2: q.yoy2 ?? null,
            })).sort((a, b) => a.date.localeCompare(b.date));

            const yearlyData = {};
            monthlyData.forEach(d => {
                const year = d.date.split('-')[0];
                if (!yearlyData[year]) yearlyData[year] = { revenue1: 0, revenue2: 0, count1: 0, count2: 0 };
                if (d.revenue1 !== null) {
                    yearlyData[year].revenue1 += d.revenue1;
                    yearlyData[year].count1++;
                }
                if (d.revenue2 !== null) {
                    yearlyData[year].revenue2 += d.revenue2;
                    yearlyData[year].count2++;
                }
            });
            
            Object.keys(yearlyData).forEach(year => {
                const lastYear = parseInt(year) - 1;
                if (yearlyData[lastYear]) {
                    const lastY = yearlyData[lastYear];
                    const currentY = yearlyData[year];
                    if (lastY.revenue1 > 0 && lastY.count1 === 12 && currentY.count1 === 12) {
                       currentY.yoy1 = ((currentY.revenue1 - lastY.revenue1) / lastY.revenue1) * 100;
                    }
                     if (lastY.revenue2 > 0 && lastY.count2 === 12 && currentY.count2 === 12) {
                       currentY.yoy2 = ((currentY.revenue2 - lastY.revenue2) / lastY.revenue2) * 100;
                    }
                }
            });

            const yearlyArray = Object.entries(yearlyData).map(([year, y]) => ({
                date: year,
                revenue1: y.revenue1,
                revenue2: y.revenue2,
                yoy1: y.yoy1 ?? null,
                yoy2: y.yoy2 ?? null,
            })).sort((a, b) => a.date - b.date);

            return { monthlyData, quarterlyArray, yearlyArray };
        }

        // --- Charting (Adapted) ---
        function createComparisonCharts(data, name1, name2) {
            const n1 = name1 || "Company 1";
            const n2 = name2 || "Company 2";

            const charts = [monthlyChart, monthlyYoYChart, quarterlyChart, quarterlyYoYChart, yearlyChart, yearlyYoYChart];
            charts.forEach(chart => { if(chart) chart.destroy(); });

            const revenueChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Revenue (TWD, Millions)'
                        }
                    }
                }
            };

            const yoyChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'YoY Growth (%)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(2) + '%';
                            }
                        }
                    }
                }
            };

            const createChart = (ctx, type, labels, datasets, options) => new Chart(ctx, { type, data: { labels, datasets }, options });

            monthlyChart = createChart(document.getElementById('monthlyChart').getContext('2d'), 'bar', data.monthlyData.map(d => d.date), [
                { label: n1, data: data.monthlyData.map(d => d.revenue1), backgroundColor: 'rgba(102, 126, 234, 0.7)' },
                { label: n2, data: data.monthlyData.map(d => d.revenue2), backgroundColor: 'rgba(52, 152, 219, 0.7)' }
            ], revenueChartOptions);

            monthlyYoYChart = createChart(document.getElementById('monthlyYoYChart').getContext('2d'), 'line', data.monthlyData.map(d => d.date), [
                { label: `${n1} YoY %`, data: data.monthlyData.map(d => d.yoy1), borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', borderWidth: 2, fill: true },
                { label: `${n2} YoY %`, data: data.monthlyData.map(d => d.yoy2), borderColor: '#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', borderWidth: 2, fill: true, borderDash: [5, 5] }
            ], yoyChartOptions);

            quarterlyChart = createChart(document.getElementById('quarterlyChart').getContext('2d'), 'bar', data.quarterlyArray.map(d => d.date), [
                { label: n1, data: data.quarterlyArray.map(d => d.revenue1), backgroundColor: 'rgba(102, 126, 234, 0.7)' },
                { label: n2, data: data.quarterlyArray.map(d => d.revenue2), backgroundColor: 'rgba(52, 152, 219, 0.7)' }
            ], revenueChartOptions);

            quarterlyYoYChart = createChart(document.getElementById('quarterlyYoYChart').getContext('2d'), 'line', data.quarterlyArray.map(d => d.date), [
                { label: `${n1} YoY %`, data: data.quarterlyArray.map(d => d.yoy1), borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', borderWidth: 2, fill: true },
                { label: `${n2} YoY %`, data: data.quarterlyArray.map(d => d.yoy2), borderColor: '#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', borderWidth: 2, fill: true, borderDash: [5, 5] }
            ], yoyChartOptions);

            yearlyChart = createChart(document.getElementById('yearlyChart').getContext('2d'), 'bar', data.yearlyArray.map(d => d.date), [
                { label: n1, data: data.yearlyArray.map(d => d.revenue1), backgroundColor: 'rgba(102, 126, 234, 0.7)' },
                { label: n2, data: data.yearlyArray.map(d => d.revenue2), backgroundColor: 'rgba(52, 152, 219, 0.7)' }
            ], revenueChartOptions);

            yearlyYoYChart = createChart(document.getElementById('yearlyYoYChart').getContext('2d'), 'line', data.yearlyArray.map(d => d.date), [
                { label: `${n1} YoY %`, data: data.yearlyArray.map(d => d.yoy1), borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', borderWidth: 2, fill: true },
                { label: `${n2} YoY %`, data: data.yearlyArray.map(d => d.yoy2), borderColor: '#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', borderWidth: 2, fill: true, borderDash: [5, 5] }
            ], yoyChartOptions);

            document.getElementById('toggleCompany1').onchange = updateChartVisibility;
            document.getElementById('toggleCompany2').onchange = updateChartVisibility;
            updateChartVisibility();
        }

        function updateChartVisibility() {
            const show1 = document.getElementById('toggleCompany1').checked;
            const show2 = document.getElementById('companyCode2').value.trim() && document.getElementById('toggleCompany2').checked;
            [monthlyChart, monthlyYoYChart, quarterlyChart, quarterlyYoYChart, yearlyChart, yearlyYoYChart].forEach(chart => {
                if (chart) {
                    chart.data.datasets[0].hidden = !show1;
                    if (chart.data.datasets[1]) chart.data.datasets[1].hidden = !show2;
                    chart.update();
                }
            });
        }

        // --- Table Population (Adapted) ---
        function populateComparisonTable(results1, results2) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            const allMonths = new Set([
                ...results1.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`),
                ...results2.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`)
            ]);
            const sortedMonths = Array.from(allMonths).sort().reverse(); // Show most recent first

            sortedMonths.forEach(dateStr => {
                const [year, month] = dateStr.split('-').map(Number);
                const r1 = results1.find(r => r && r.year === year && r.month === month);
                const r2 = results2.find(r => r && r.year === year && r.month === month);
                const row = tbody.insertRow();
                row.insertCell().textContent = dateStr;
                const formatNum = (num) => (num !== null && num !== undefined) ? num.toLocaleString(undefined, {maximumFractionDigits: 2}) : 'N/A';
                const formatPercent = (p) => (p !== null && p !== undefined) ? `${p.toFixed(2)}%` : 'N/A';
                
                row.insertCell().textContent = formatNum(r1?.revenue);
                const yoy1Cell = row.insertCell();
                yoy1Cell.textContent = formatPercent(r1?.yoy_percent);
                yoy1Cell.className = r1?.yoy_percent > 0 ? 'positive' : 'negative';
                row.insertCell().textContent = formatNum(r1?.ytd_revenue);
                
                row.insertCell().textContent = formatNum(r2?.revenue);
                const yoy2Cell = row.insertCell();
                yoy2Cell.textContent = formatPercent(r2?.yoy_percent);
                yoy2Cell.className = r2?.yoy_percent > 0 ? 'positive' : 'negative';
                row.insertCell().textContent = formatNum(r2?.ytd_revenue);
            });
        }

        // --- Main Application Logic (New) ---
        async function fetchAndDisplayData() {
            const code1 = document.getElementById('companyCode1').value.trim();
            const code2 = document.getElementById('companyCode2').value.trim();
            const startDate = document.getElementById('startDate').value;

            if (!code1 || !startDate) {
                showError('Please select a primary company and a start date.');
                return;
            }

            const loadingDiv = document.getElementById('loading');
            const fetchBtn = document.getElementById('fetchBtn');
            const globalControls = document.getElementById('globalToggleControls');

            // Reset UI
            loadingDiv.style.display = 'block';
            fetchBtn.disabled = true;
            globalControls.style.display = 'none';
            document.getElementById('chartsContainer').style.display = 'none';
            document.getElementById('dataTableContainer').style.display = 'none';
            document.getElementById('companyName1').style.display = 'none';
            document.getElementById('companyName2').style.display = 'none';
            document.getElementById('marketCap1').style.display = 'none';
            document.getElementById('marketCap2').style.display = 'none';
            clearError();

            try {
                const results = await Promise.allSettled([
                    fetchRevenueData(code1, startDate),
                    fetchRevenueData(code2, startDate),
                    fetchMarketCap(code1),
                    fetchMarketCap(code2)
                ]);

                const result1 = results[0].status === 'fulfilled' ? results[0].value : null;
                const result2 = results[1].status === 'fulfilled' ? results[1].value : null;
                const marketCap1 = results[2].status === 'fulfilled' ? results[2].value : null;
                const marketCap2 = results[3].status === 'fulfilled' ? results[3].value : null;

                allData1 = result1 ? result1.data : [];
                allData2 = result2 ? result2.data : [];
                
                const name1 = result1 ? result1.companyName : `Company ${code1}`;
                const name2 = result2 ? result2.companyName : `Company ${code2}`;

                // Update UI elements
                document.getElementById('companyName1').textContent = `${name1} (${code1})`;
                document.getElementById('companyName1').style.display = 'block';

                if (marketCap1 && marketCap1.marketCap) {
                    const marketCapTWD_Yi = (marketCap1.marketCap / 100000000).toFixed(2);
                    const marketCapUSD_M = (marketCap1.marketCapUSD / 1000000).toFixed(2);
                    const marketCapText = `
                        Market Cap. <b>${marketCapTWD_Yi}億 TWD</b> (~${marketCapUSD_M}M USD)<br>
                        Total issued share: ${marketCap1.issuedShares.toLocaleString()}<br>
                        Latest price: ${marketCap1.stockPrice} TWD (quoted on ${marketCap1.priceDate})
                    `;
                    document.getElementById('marketCap1').innerHTML = marketCapText;
                    document.getElementById('marketCap1').style.display = 'block';
                } else {
                    document.getElementById('marketCap1').style.display = 'none';
                    if(code1) showWarning(`Could not retrieve market cap for ${name1} (${code1}).`);
                }

                document.getElementById('toggleCompany1Label').textContent = name1;
                
                const hasCompany2 = !!code2;
                document.getElementById('toggleCompany2').parentElement.style.display = hasCompany2 ? 'inline-block' : 'none';
                document.getElementById('toggleCompany2Label').style.display = hasCompany2 ? 'inline-block' : 'none';
                
                if (hasCompany2) {
                    document.getElementById('companyName2').textContent = `${name2} (${code2})`;
                    document.getElementById('companyName2').style.display = 'block';
                     if (marketCap2 && marketCap2.marketCap) {
                        const marketCapTWD_Yi = (marketCap2.marketCap / 100000000).toFixed(2);
                        const marketCapUSD_M = (marketCap2.marketCapUSD / 1000000).toFixed(2);
                        const marketCapText = `
                            Market Cap. <b>${marketCapTWD_Yi}億 TWD</b> (~${marketCapUSD_M}M USD)<br>
                            Total issued share: ${marketCap2.issuedShares.toLocaleString()}<br>
                            Latest price: ${marketCap2.stockPrice} TWD (quoted on ${marketCap2.priceDate})
                        `;
                        document.getElementById('marketCap2').innerHTML = marketCapText;
                        document.getElementById('marketCap2').style.display = 'block';
                    } else {
                        document.getElementById('marketCap2').style.display = 'none';
                        if(code2) showWarning(`Could not retrieve market cap for ${name2} (${code2}).`);
                    }
                    document.getElementById('toggleCompany2Label').textContent = name2;
                } else {
                    document.getElementById('companyName2').style.display = 'none';
                    document.getElementById('marketCap2').style.display = 'none';
                }
                 document.getElementById('toggleCompany2').checked = hasCompany2;


                if (allData1.length === 0) {
                    showError(`No revenue data found for ${name1} (${code1}) for the selected period.`);
                    return;
                }

                globalControls.style.display = 'flex';
                const processed = processComparisonData(allData1, allData2);
                createComparisonCharts(processed, name1, name2);
                populateComparisonTable(allData1, allData2);

                document.getElementById('chartsContainer').style.display = 'grid';
                document.getElementById('dataTableContainer').style.display = 'block';
                showSuccess('Data loaded successfully.');

                if (code2 && allData2.length === 0) {
                    showWarning(`No revenue data found for ${name2} (${code2}), showing only primary company.`);
                }

            } catch (err) {
                showError(`System Error: ${err.message}`);
            } finally {
                loadingDiv.style.display = 'none';
                fetchBtn.disabled = false;
            }
        }

        function showError(msg) { document.getElementById('errorContainer').innerHTML = `<div class="error-message">❌ ${msg}</div>`; }
        function showWarning(msg) { document.getElementById('errorContainer').innerHTML += `<div class="warning-message">⚠️ ${msg}</div>`; }
        function showSuccess(msg) { document.getElementById('errorContainer').innerHTML = `<div class="success-message">✅ ${msg}</div>`; }
        function clearError() { document.getElementById('errorContainer').innerHTML = ''; }

        document.getElementById('fetchBtn').addEventListener('click', fetchAndDisplayData);
        document.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !document.getElementById('fetchBtn').disabled) {
                fetchAndDisplayData();
            }
        });

        // --- Default Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const DEFAULT_COMPANIES = {
                c1: { code: '6841', name: '長佳智能' },
                c2: { code: '6857', name: '宏碁智醫' }
            };

            // Set a fixed default start date
            document.getElementById('startDate').value = '2022-01';

            // Pre-fill the search inputs and hidden code inputs
            document.getElementById('companySearch1').value = `${DEFAULT_COMPANIES.c1.code} - ${DEFAULT_COMPANIES.c1.name}`;
            document.getElementById('companyCode1').value = DEFAULT_COMPANIES.c1.code;
            document.getElementById('companySearch2').value = `${DEFAULT_COMPANIES.c2.code} - ${DEFAULT_COMPANIES.c2.name}`;
            document.getElementById('companyCode2').value = DEFAULT_COMPANIES.c2.code;

            // Automatically fetch and display the data
            fetchAndDisplayData();
        });
    </script>
</body>
</html>
